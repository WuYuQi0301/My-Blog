---
title: SLAM Ceres和g2o基本使用
date: 2019-03-31 23:30:00
categories:
- SLAM
tag:
- slam-lab
mathjax: true
---

使用Ceres和g2o拟合曲线实验



设一个非线性模型
$$
y= exp(ax^2+bx+c)+w
$$
现有N个观测数据点，求曲线参数$a,b,c$，即
$$
min_{a,b,c}\frac{1}{2}\sum^{N}_{i=1}||y_i-exp(ax^2+bx+c)||^2
$$

## Ceres库拟合曲线

### 算法描述

0. 生成真实值并在真实值中加入随机高斯噪声模拟观测值

1. 定义Cost Function类型用于计算残差
2. 通过代价函数构建构建最小二乘问题
3. 配置求解器参数并求解问题

#### 核心代码

1. Cost 函数中需要定义'()'运算符函数，返回用输入参数abc计算的(_x,\_y)处的残差：

   ```c++
   template <typename T>
   bool operator() (const T* const abc, T* residual ) const     
   {
       residual[0] = T ( _y ) - ceres::exp ( abc[0]*T ( _x ) *T ( _x ) + abc[1]*T ( _x ) + abc[2] ); // y-exp(ax^2+bx+c)
       return true;
   }
   ```

2. 构建最小二乘问题：使用ceres库的Problem类的*AddResidualBlock*方法。

   - *AddResidualBlock* 负责将误差项添加到目标函数中。由于优化需要梯度，这里选择使用自动求导函数*AddDiffCostFunction*。后面两个参数分别为核函数（不使用）和待求解参数。

   - *AddDiffCostFunction\<T,i,j>*本身是一个模板函数，参数为：<误差类型，输出维度，输入维度>。这里1为输出一维残差值，3为输入参数abc，与前面定义的Cost functions中一致。

   ```c++
   ceres::Problem problem;
   problem.AddResidualBlock (new ceres::AutoDiffCostFunction<CURVE_FITTING_COST, 1, 3> (new CURVE_FITTING_COST ( x_data[i], y_data[i] )), nullptr,abc);
   ```

3. 配置求解器并求解问题（这里删掉了计时函数）

   ```c++
       // 配置求解器
       ceres::Solver::Options options;     // 配置项
       options.linear_solver_type = ceres::DENSE_QR;  // 定义增量方程求解方法
       options.minimizer_progress_to_stdout = true;   // 输出到cout
   
       ceres::Solver::Summary summary;                // 创建一个优化信息的summary
       ceres::Solve ( options, &problem, &summary );  // 开始优化
       cout<<summary.BriefReport() <<endl;            // 输出结果
   ```

### 结果分析

设定的参数真实值为$a =1, b = 2, c = 1$。

运行结果非常长，截取了一下信息，完整的放到了报告最后。

> solve time cost = 0.00353049 seconds. 
> Ceres Solver Report: Iterations: 22, Initial cost: 1.824887e+04, Final cost: 5.096854e+01, Termination: CONVERGENCE
> estimated a,b,c = 0.891943 2.17039 0.944142

可以看到，程序通过固定区间取x值并在相应y值处加入高斯噪声，生成了100个“观测点”。整体误差从1.824887e+04下降到5.096854e+01，梯度越来越小，并且在迭代22次后算法收敛。最后参数估计值如下，与真实值较为接近。
$$
a= 0.891943\ \  b= 2.17039\ \  c= 0.944142
$$


## g2o库拟合曲线





## 运行结果

### Ceres

forslam@ubuntu:~/slambook/ch6/ceres_curve_fitting/build$ ./curve_fitting 
generating data: 
0 2.71828
0.01 2.93161
0.02 2.12942
0.03 2.46037
0.04 4.18814
0.05 2.73368
0.06 2.42751
0.07 3.44729
0.08 3.72543
0.09 2.1358
0.1 4.12333
0.11 3.38199
0.12 4.81164
0.13 1.62582
0.14 1.76862
0.15 3.21555
0.16 3.0922
0.17 5.82752
0.18 4.29855
0.19 2.74081
0.2 5.75724
0.21 3.53729
0.22 1.95514
0.23 2.99195
0.24 3.28739
0.25 4.70749
0.26 6.24365
0.27 5.81645
0.28 4.88402
0.29 4.75991
0.3 7.25246
0.31 5.92933
0.32 7.00306
0.33 5.22286
0.34 5.16179
0.35 7.26191
0.36 6.40545
0.37 6.25549
0.38 6.56094
0.39 6.53523
0.4 8.14891
0.41 7.77616
0.42 7.40141
0.43 8.75638
0.44 7.20606
0.45 7.57795
0.46 8.21564
0.47 9.84032
0.48 6.96725
0.49 9.90619
0.5 9.27125
0.51 9.87567
0.52 10.3412
0.53 9.55315
0.54 11.3635
0.55 10.8815
0.56 13.0648
0.57 11.4756
0.58 11.337
0.59 13.2393
0.6 13.5299
0.61 14.0441
0.62 13.31
0.63 13.672
0.64 14.8504
0.65 14.2599
0.66 14.7724
0.67 17.4339
0.68 17.4632
0.69 17.7598
0.7 16.8223
0.71 19.9468
0.72 20.5446
0.73 21.3767
0.74 20.1435
0.75 20.3088
0.76 23.2543
0.77 23.4349
0.78 22.8706
0.79 24.094
0.8 25.4183
0.81 25.5237
0.82 27.9738
0.83 28.5861
0.84 29.5703
0.85 29.6744
0.86 32.667
0.87 34.2698
0.88 33.5124
0.89 36.1479
0.9 39.2485
0.91 40.988
0.92 41.5716
0.93 41.3686
0.94 44.285
0.95 42.8312
0.96 47.7941
0.97 48.5931
0.98 51.8487
0.99 51.0258
iter  cost                 cost_change  |gradient|   |step|    tr_ratio       tr_radius  ls_iter  iter_time  total_time
   0  1.824887e+04    0.00e+00    1.38e+03   0.00e+00   0.00e+00  1.00e+04        0    5.51e-05    2.35e-04
   1  2.748700e+39   -2.75e+39    0.00e+00   7.67e+01  -1.52e+35  5.00e+03        1    4.82e-05    8.88e-04
   2  2.429783e+39   -2.43e+39    0.00e+00   7.62e+01  -1.35e+35  1.25e+03        1    1.88e-05    9.23e-04
   3  1.213227e+39   -1.21e+39    0.00e+00   7.30e+01  -6.73e+34  1.56e+02        1    1.60e-05    9.50e-04
   4  1.852387e+37   -1.85e+37    0.00e+00   5.56e+01  -1.03e+33  9.77e+00        1    2.00e-05    1.04e-03
   5  6.714689e+31   -6.71e+31    0.00e+00   2.96e+01  -3.85e+27  3.05e-01        1    2.60e-05    1.27e-03
   6  9.500531e+12   -9.50e+12    0.00e+00   9.50e+00  -8.39e+08  4.77e-03        1    1.72e-05    1.30e-03
   7  1.776982e+04    4.79e+02    1.83e+03   2.58e-01   1.18e+00  1.43e-02        1    3.98e-04    2.41e-03
   8  1.599969e+04    1.77e+03    3.45e+03   5.53e-01   1.46e+00  4.29e-02        1    3.48e-05    2.47e-03
   9  1.060557e+04    5.39e+03    7.62e+03   7.33e-01   1.68e+00  1.29e-01        1    5.32e-05    2.53e-03
  10  3.669783e+03    6.94e+03    9.60e+03   5.25e-01   1.39e+00  3.86e-01        1    3.10e-05    2.57e-03
  11  5.397541e+02    3.13e+03    5.00e+03   2.66e-01   1.12e+00  1.16e+00        1    3.10e-05    2.61e-03
  12  1.484444e+02    3.91e+02    1.22e+03   8.46e-02   1.02e+00  3.48e+00        1    3.10e-05    2.65e-03
  13  1.216815e+02    2.68e+01    3.76e+02   4.17e-02   1.01e+00  1.04e+01        1    2.88e-05    2.69e-03
  14  9.290109e+01    2.88e+01    2.42e+02   9.10e-02   1.01e+00  3.13e+01        1    3.00e-05    2.73e-03
  15  6.674330e+01    2.62e+01    1.09e+02   1.33e-01   1.00e+00  9.39e+01        1    3.81e-05    2.77e-03
  16  5.936574e+01    7.38e+00    2.14e+01   1.08e-01   9.94e-01  2.82e+02        1    2.81e-05    2.81e-03
  17  5.653118e+01    2.83e+00    1.36e+01   1.57e-01   9.98e-01  8.45e+02        1    2.81e-05    2.84e-03
  18  5.310764e+01    3.42e+00    8.50e+00   2.81e-01   9.89e-01  2.53e+03        1    2.81e-05    2.88e-03
  19  5.125939e+01    1.85e+00    2.84e+00   2.98e-01   9.90e-01  7.60e+03        1    3.60e-05    3.19e-03
  20  5.097693e+01    2.82e-01    4.34e-01   1.48e-01   9.95e-01  2.28e+04        1    3.19e-05    3.29e-03
  21  5.096854e+01    8.39e-03    3.24e-02   2.87e-02   9.96e-01  6.84e+04        1    3.10e-05    3.39e-03
solve time cost = 0.00353049 seconds. 
Ceres Solver Report: Iterations: 22, Initial cost: 1.824887e+04, Final cost: 5.096854e+01, Termination: CONVERGENCE
estimated a,b,c = 0.891943 2.17039 0.944142